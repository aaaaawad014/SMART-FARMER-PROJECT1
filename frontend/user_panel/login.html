<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Farmer Login</title>
  <style>
    :root{
      --bg:#070b14;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.12);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.75);
      --blue:#2d6cdf;
      --blue2:#58a6ff;
      --danger:#ff8a8a;
      --shadow:0 18px 44px rgba(0,0,0,.55);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Segoe UI,Arial;
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(88,166,255,.18), transparent 60%),
        radial-gradient(700px 420px at 80% 30%, rgba(45,108,223,.16), transparent 55%),
        linear-gradient(180deg,#050812,#070b14 45%,#070b14);
      padding:20px;
    }
    .card{
      width:420px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
    }
    h1{
      margin:0 0 6px;
      font-size:1.35rem;
      text-align:center;
    }
    .sub{
      margin:0 0 18px;
      color:var(--muted);
      font-size:.95rem;
      text-align:center;
    }
    label{
      display:block;
      color:var(--muted);
      font-size:.9rem;
      margin:10px 0 6px;
    }
    input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.07);
      color:var(--text);
      outline:none;
    }
    input:focus{
      border-color:rgba(88,166,255,.65);
    }
    .btn{
      width:100%;
      margin-top:14px;
      padding:12px 14px;
      border:0;
      border-radius:12px;
      background:linear-gradient(135deg,var(--blue),var(--blue2));
      color:#fff;
      font-weight:800;
      cursor:pointer;
      transition:all 0.3s;
    }
    .btn:hover{
      filter:brightness(1.05);
      transform:translateY(-2px);
    }
    .btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
      transform:none;
    }
    .row{
      display:flex;
      justify-content:space-between;
      margin-top:14px;
      gap:10px;
    }
    a{
      color:#8ab4ff;
      text-decoration:none;
      font-weight:600;
    }
    a:hover{
      text-decoration:underline;
    }
    /* Modal */
    .modalBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:1000;
    }
    .modal{
      width:420px;
      max-width:95vw;
      background:rgba(10,14,26,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.65);
      padding:16px;
    }
    .mHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .mTitle{
      font-weight:900;
      font-size:1.2rem;
    }
    .mClose{
      border:0;
      background:transparent;
      color:var(--muted);
      font-size:24px;
      cursor:pointer;
      width:30px;
      height:30px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:50%;
    }
    .mClose:hover{
      background:rgba(255,255,255,.1);
    }
    .mBody{
      color:var(--muted);
      margin-top:8px;
      line-height:1.5;
      font-size:0.95rem;
    }
    .mBtns{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:14px;
    }
    .mBtn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      min-width:80px;
      transition:all 0.2s;
    }
    .mBtn:hover{
      background:rgba(255,255,255,.1);
    }
    .mBtn.primary{
      background:linear-gradient(135deg,var(--blue),var(--blue2));
      border:0;
    }
    .mBtn.primary:hover{
      filter:brightness(1.1);
    }
    .mBtn.danger{
      background:rgba(255,138,138,.12);
      border:1px solid rgba(255,138,138,.35);
      color:#ffb3b3;
    }
    .mBtn.danger:hover{
      background:rgba(255,138,138,.2);
    }
    .forgot-password{
      text-align:center;
      margin-top:10px;
      font-size:0.9rem;
    }
    .debug-info{
      margin-top:20px;
      padding:10px;
      background:rgba(255,255,255,.05);
      border-radius:8px;
      font-size:0.8rem;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Farmer Login</h1>
    <p class="sub">Login to manage your crops, inventory, and complaints</p>

    <label>Email Address</label>
    <input 
      id="email" 
      type="email" 
      placeholder="farmer@example.com"
      autocomplete="email"
    />

    <label>Password</label>
    <input 
      id="password" 
      type="password" 
      placeholder="Enter your password"
      autocomplete="current-password"
    />

    <button class="btn" id="loginBtn">Login</button>

    <div class="forgot-password">
      <a href="#" onclick="resetPassword()">Forgot Password?</a>
    </div>

    <div class="row">
      <a href="signup.html">Create new account</a>
      <a href="../index.html">Back to Home</a>
    </div>

    <!-- Debug info (visible in console only) -->
    <div class="debug-info" style="display:none;" id="debugInfo">
      <div>Checking Firebase connection...</div>
      <div id="firebaseStatus"></div>
      <div id="upsertStatus"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="mHead">
        <div class="mTitle" id="mTitle">Message</div>
        <button class="mClose" id="mClose">√ó</button>
      </div>
      <div class="mBody" id="mBody"></div>
      <div class="mBtns" id="mBtns"></div>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="../js/firebase-config.js"></script>
  <script src="../js/auth.js"></script>

  <script>
    // ========== INITIALIZATION ==========
    console.log("üîß Login page initialized");
    
    // Show debug info if holding Shift on page load
    document.addEventListener('keydown', (e) => {
      if (e.shiftKey && e.key === 'D') {
        document.getElementById('debugInfo').style.display = 'block';
      }
    });

    // ========== POPUP SYSTEM ==========
    const modalBack = document.getElementById("modalBack");
    const mTitle = document.getElementById("mTitle");
    const mBody = document.getElementById("mBody");
    const mBtns = document.getElementById("mBtns");
    
    document.getElementById("mClose").onclick = () => {
      modalBack.style.display = "none";
    };
    
    // Close modal on background click
    modalBack.onclick = (e) => {
      if (e.target === modalBack) {
        modalBack.style.display = "none";
      }
    };
    
    function popup({title = "Message", message = "", buttons = [{text: "OK", type: "primary"}]}) {
      console.log("üì¢ Popup:", title);
      mTitle.textContent = title;
      mBody.textContent = message;
      mBtns.innerHTML = "";
      
      buttons.forEach(btn => {
        const button = document.createElement("button");
        button.className = "mBtn " + (btn.type || "");
        button.textContent = btn.text || "OK";
        button.onclick = () => {
          if (btn.onClick) btn.onClick();
          modalBack.style.display = "none";
        };
        mBtns.appendChild(button);
      });
      
      modalBack.style.display = "flex";
    }

    // ========== PASSWORD RESET ==========
    function resetPassword() {
      const email = document.getElementById("email").value.trim();
      
      if (!email) {
        popup({
          title: "Enter Email",
          message: "Please enter your email address to reset password.",
          buttons: [{text: "OK", type: "primary"}]
        });
        return;
      }
      
      popup({
        title: "Reset Password",
        message: `Send password reset email to ${email}?`,
        buttons: [
          {text: "Cancel", type: ""},
          {
            text: "Send Reset Email",
            type: "primary",
            onClick: async () => {
              try {
                await firebase.auth().sendPasswordResetEmail(email);
                popup({
                  title: "Email Sent ‚úÖ",
                  message: "Check your email for password reset instructions.",
                  buttons: [{text: "OK", type: "primary"}]
                });
              } catch (error) {
                popup({
                  title: "Error ‚ùå",
                  message: error.message,
                  buttons: [{text: "OK", type: "danger"}]
                });
              }
            }
          }
        ]
      });
    }

    // ========== LOGIN FUNCTION ==========
    document.getElementById("loginBtn").addEventListener("click", performLogin);
    
    // Enter key support
    document.addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        performLogin();
      }
    });
    
    async function performLogin() {
      console.log("üîê Login process started");
      
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const loginBtn = document.getElementById("loginBtn");

      // Validation
      if (!email || !password) {
        popup({
          title: "Missing Information",
          message: "Please enter both email and password.",
          buttons: [{text: "OK", type: "primary"}]
        });
        return;
      }

      try {
        // Show loading state
        loginBtn.disabled = true;
        loginBtn.textContent = "Logging in...";

        console.log("1. Firebase authentication...");
        
        // 1. Authenticate with Firebase
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        console.log("‚úÖ Firebase login successful:", user.email);
        console.log("User UID:", user.uid);
        console.log("User displayName:", user.displayName);

        // 2. Save/update user in MongoDB
        console.log("2. Syncing with MongoDB...");
        
        if (typeof window.upsertProfile === 'function') {
          try {
            const mongoResult = await window.upsertProfile(user.displayName || "");
            console.log("‚úÖ MongoDB sync result:", mongoResult);
            
            if (mongoResult && mongoResult._id) {
              console.log("üéâ User saved to MongoDB with ID:", mongoResult._id);
            } else {
              console.log("‚ö†Ô∏è MongoDB sync completed but no _id returned");
            }
          } catch (mongoError) {
            console.warn("‚ö†Ô∏è MongoDB sync failed, but Firebase login succeeded:", mongoError.message);
            // Continue even if MongoDB fails
          }
        } else {
          console.error("‚ùå upsertProfile function not available!");
        }

        // 3. Success - show welcome message
        const userName = user.displayName || user.email.split('@')[0];
        
        popup({
          title: "Login Successful! ‚úÖ",
          message: `Welcome back, ${userName}! Redirecting to your dashboard...`,
          buttons: [{
            text: "Go to Dashboard",
            type: "primary",
            onClick: () => {
              window.location.href = "dashboard.html";
            }
          }]
        });

        // Auto-redirect after 3 seconds
        setTimeout(() => {
          window.location.href = "dashboard.html";
        }, 3000);

      } catch (error) {
        console.error("‚ùå Login error:", error);
        
        // Reset button state
        loginBtn.disabled = false;
        loginBtn.textContent = "Login";
        
        // Handle specific Firebase errors
        let errorMessage = error.message;
        if (error.code === 'auth/user-not-found') {
          errorMessage = "No account found with this email. Please sign up first.";
        } else if (error.code === 'auth/wrong-password') {
          errorMessage = "Incorrect password. Please try again.";
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = "Invalid email address format.";
        } else if (error.code === 'auth/too-many-requests') {
          errorMessage = "Too many failed attempts. Please try again later.";
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = "Network error. Check your internet connection.";
        }
        
        popup({
          title: "Login Failed ‚ùå",
          message: errorMessage,
          buttons: [{text: "Try Again", type: "danger"}]
        });
      }
    }

    // ========== AUTO-FILL FOR TESTING ==========
    // Remove this in production!
    function autoFillTestCredentials() {
      if (window.location.href.includes('localhost')) {
        document.getElementById('email').value = 'test@example.com';
        document.getElementById('password').value = '123456';
        console.log('Test credentials auto-filled (dev only)');
      }
    }
    
    // Uncomment for development testing:
    // autoFillTestCredentials();

    // ========== DEBUG: CHECK AVAILABLE FUNCTIONS ==========
    console.log("üîç Function Check:");
    console.log("- upsertProfile available:", typeof window.upsertProfile === 'function');
    console.log("- firebase.auth available:", typeof firebase.auth !== 'undefined');
    console.log("- firebase.auth().currentUser:", firebase.auth().currentUser);
    
    // Check if user is already logged in
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        console.log("‚ö†Ô∏è User already logged in:", user.email);
        console.log("Redirecting to dashboard...");
        setTimeout(() => {
          window.location.href = "dashboard.html";
        }, 1000);
      }
    });

    // ========== FALLBACK: SIMPLE UPSERTPROFILE ==========
    if (typeof window.upsertProfile === 'undefined') {
      console.warn("‚ö†Ô∏è upsertProfile not found, creating fallback function");
      
      window.upsertProfile = async function(name = "") {
        console.log("üîÑ Using fallback upsertProfile");
        
        try {
          const user = firebase.auth().currentUser;
          if (!user) {
            console.error("No user logged in");
            return null;
          }
          
          const token = await user.getIdToken();
          
          const response = await fetch("http://localhost:3000/api/users/upsert", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ name: name || user.displayName || "" })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          return await response.json();
          
        } catch (error) {
          console.error("Fallback upsertProfile failed:", error);
          return null;
        }
      };
      
      console.log("‚úÖ Fallback upsertProfile created");
    }
  </script>
</body>
</html>